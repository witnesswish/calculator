name: CMake Build Qt Project

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  QT_VERSION: '6.9.0'  # 根据需要调整 Qt 版本
  ANDROID_NDK_VERSION: '26.1.10909125'  # Android NDK 版本
  ANDROID_SDK_VERSION: '19.0'       # Android SDK 版本

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libgl1-mesa-dev
        
    - name: Set up Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: ${{ env.QT_VERSION }}
        host: linux
        target: desktop
        #tools: true
      
    - name: Configure and build
      run: |
        mkdir -p build/linux
        cd build/linux
        cmake -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=Release ../..
        cmake --build . --config Release --parallel $(nproc)
        
    - name: Archive artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-build
        path: build/linux/

  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
      
    - name: Set up Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: ${{ env.QT_VERSION }}
        host: windows
        target: desktop
        #tools: true
      
    - name: Configure and build
      run: |
        mkdir build\windows
        cd build\windows
        cmake -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release ..\..
        cmake --build . --config Release
      
    - name: Archive artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: build/windows/

  build-android:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      
    - name: Set up JDK
      uses: actions/setup-java@v3.14.1
      with:
        java-version: '17'
        distribution: 'temurin'
      
    - name: Set up Android SDK and NDK
      uses: android-actions/setup-android@v3.2.1
      
    - name: Set up Qt for Android
      uses: jurplel/install-qt-action@v4
      with:
        version: ${{ env.QT_VERSION }}
        host: linux
        target: android
        android-ndk: ${{ env.ANDROID_NDK_VERSION }}
        android-sdk: ${{ env.ANDROID_SDK_VERSION }}
        #tools: true
      
    - name: Configure and build Android APK
      run: |
        mkdir -p build/android
        cd build/android
        cmake \
          -DCMAKE_SYSTEM_NAME=Android \
          -DCMAKE_ANDROID_NDK=$ANDROID_NDK_ROOT \
          -DCMAKE_ANDROID_ARCH_ABI=arm64-v8a \
          -DCMAKE_ANDROID_STL_TYPE=c++_shared \
          -DQT_HOST_PATH=$QT_HOST_DIR \
          -DCMAKE_TOOLCHAIN_FILE=$QT_DIR/lib/cmake/Qt6/qt.toolchain.cmake \
          -DCMAKE_BUILD_TYPE=Release \
          ../..
        cmake --build . --config Release --parallel $(nproc)
      
    - name: Archive APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: build/android/*.apk
